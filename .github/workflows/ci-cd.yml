# 文件路径：.github/workflows/ci-cd.yml

name: Flask App CI/CD Pipeline

# 定义何时触发这个工作流
on:
  push:
    branches:
      - main  # 当代码推送到 main 分支时触发

# 定义工作流中的所有任务 (Jobs)
jobs:
  # Job 1: 持续集成 (CI) 阶段
  build-and-test:
    name: CI - Build and Test
    # 告诉 GitHub Actions 在一个最新的 Ubuntu 虚拟机上运行这个任务
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码 (Checkout code)
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Python 环境 (Setup Python)
      - name: 设置 Python 3.9 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 3. 运行简单的测试 (Run Test)
      - name: 运行简单的代码检查 (模拟测试)
        run: |
          # 模拟测试通过：Python 应用代码质量检查通过。
          echo "Test passed: Python application code quality check passed."
          
      # 4. 模拟构建 Docker 镜像 (作为 CI 阶段的最后检查)
      - name: 模拟 Docker 镜像构建 (但不保存)
        run: docker build --no-cache .
        
  # Job 2: 持续部署 (CD) 阶段
  deploy: # <-- 这是 deploy 任务的头部定义，与 build-and-test 平齐
    name: CD - Deploy to Docker
    # 确保只有 CI 任务成功后，CD 任务才开始
    needs: [build-and-test] 
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Docker 环境 (包括构建工具)
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录 Docker Hub (使用我们设置的 Secrets)
      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 4. 构建并推送到 Docker Hub
      - name: 构建并推送到 Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          # 推送（push: true）到 Docker Hub
          push: true
          # 镜像名称和Tag：
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/flask-ci-cd-demo:latest
            ${{ secrets.DOCKER_USERNAME }}/flask-ci-cd-demo:${{ github.run_id }}
